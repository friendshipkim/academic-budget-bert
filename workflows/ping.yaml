# This workflow demonstrates the use of a generator step which produces a list of items as a result.
# This list is subsequently used for expanding the next step into multiple parallel steps.
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: ping
spec:
  volumes:
  - name: argo-aws-cred
    configMap:
      name: argo-aws-cred
  - name: argo-aws-config
    configMap:
      name: argo-aws-config
  - name: dshm
    emptyDir:
      medium: Memory
  - name: vast-vd-nfs
    hostPath:
      path: /mobileye/ALGO_VAST/mobileye-team-vd/gal/stitching/
      type: Directory
  entrypoint: s3-2-op
  templates:
  - name: s3-2-op
    steps:
    - - name: angie-exec
        template: angie-exec
  - name: angie-exec
    tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
    nodeSelector:
      gpu: nvidia-a100
      kubernetes.io/hostname: megpua100-a09
    container:
      env:
        - name: OP_S3_STORAGE
          valueFrom:
            secretKeyRef:
              name: op-s3-storage
              key: endpointurl
      imagePullPolicy: Always
      image: artifactory.sddc.mobileye.com/angie-docker-dev/galk/dbert-argo:latest
      resources:
        requests:
          memory: 480Gi
          cpu: 80
          nvidia.com/gpu: '4'
        limits:
          memory: 480Gi
          cpu: 80
          nvidia.com/gpu: '4'
      command: [bash, -c]
      args: 
        - >-
          eval `ssh-agent`; 
          ssh-add docker/id_rsa; 
          mkdir ~/.ssh; 
          touch  ~/.ssh/known_hosts; 
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts; 
          git stash;
          git fetch;
          git switch -f gals_changes;
          python -m torch.distributed.run --nproc_per_node 4 --nnodes 1  torch-dist-test.py;
      volumeMounts:
      - name: argo-aws-cred
        mountPath: /home/me.docker/.aws/credentials
        subPath: credentials
      - name: argo-aws-config
        mountPath: /home/me.docker/.aws/config
        subPath: config
      - name: dshm
        mountPath: /dev/shm
      - name: vast-vd-nfs
        mountPath: /opt/ml/data/

